# 問卷系統優化 - 產品需求文件 (PRD)

## 🎯 產品概覽

### 專案目標
優化現有問卷系統，讓AI居民能夠基於運行記憶自然地回答問題，提升回答的真實性和一致性。

### 核心問題
- **現狀**: AI填寫問卷時僅基於靜態性格配置，回答缺乏個人經歷和記憶背景
- **目標**: AI能根據模擬過程中的記憶、經歷和互動歷史來回答問題
- **效果**: 讓問卷回答更加個性化、真實和具有連貫性

## 📋 功能需求

### 1. 記憶整合系統 (Memory Integration)

#### 1.1 記憶檢索模組
- **功能**: 從AI居民的記憶系統中檢索相關經歷
- **實現**: 整合現有的Associate記憶系統 (`modules/memory/associate.py`)
- **檢索類型**:
  - 事件記憶 (Event Memory): 特定發生的事件
  - 互動記憶 (Interaction Memory): 與其他居民的對話和互動
  - 情感記憶 (Emotional Memory): 帶有情感色彩的經歷
  - 習慣記憶 (Routine Memory): 日常行為模式

#### 1.2 記憶相關性分析
- **關鍵詞匹配**: 問題關鍵詞與記憶描述的語義匹配
- **時間權重**: 近期記憶獲得更高權重
- **重要性評分**: 基於poignancy分數的記憶重要性
- **情境關聯**: 相似情境下的記憶優先選取

### 2. 自然語言回答生成系統

#### 2.1 基於記憶的回答模板
```python
# 回答結構
{
    "記憶引用": "具體的記憶內容或經歷",
    "個人觀點": "基於經歷形成的看法",
    "情感表達": "對問題的情感反應",
    "未來展望": "基於過往經歷的期望"
}
```

#### 2.2 回答風格個性化
- **語言風格**: 依據居民年齡、職業、性格調整用詞
- **詳細程度**: 性格外向者回答較詳細，內向者較簡潔
- **情感表達**: 根據性格特質調整情感表達方式
- **專業用詞**: 職業背景影響專業術語使用

#### 2.3 一致性保證機制
- **回答記錄**: 保存歷史問卷回答，避免矛盾
- **性格一致**: 確保回答符合既定性格特徵
- **記憶一致**: 回答需與已有記憶保持邏輯一致

### 3. 問卷介面優化

#### 3.1 記憶可視化
- **記憶面板**: 顯示AI居民相關記憶片段
- **影響因子**: 展示哪些記憶影響了回答
- **回答歷程**: 展示從記憶到回答的思考過程

#### 3.2 互動式問卷設計
- **動態問題**: 基於前面回答動態調整後續問題
- **記憶提示**: 在問題旁顯示相關記憶提示
- **回答預覽**: 實時預覽AI可能的回答方向

#### 3.3 多語言支援
- **繁體中文**: 全面繁體中文介面
- **自然表達**: 符合中文表達習慣的回答
- **文化適應**: 考慮台灣地區文化背景

## 🛠 技術實現方案

### 1. 記憶檢索引擎

#### 1.1 記憶查詢接口
```python
class MemoryRetriever:
    def retrieve_relevant_memories(self, agent_name: str, question: str, 
                                 context: dict) -> List[Concept]:
        """檢索與問題相關的記憶"""
        
    def analyze_memory_relevance(self, memory: Concept, 
                               question: str) -> float:
        """分析記憶與問題的相關性"""
        
    def filter_memories_by_time(self, memories: List[Concept], 
                               time_range: int) -> List[Concept]:
        """按時間範圍過濾記憶"""
```

#### 1.2 語義匹配系統
- **使用現有Embedding**: 利用已有的chromadb向量搜索
- **關鍵詞擴展**: 擴展問題關鍵詞的同義詞
- **主題分類**: 將問題分類到特定主題領域

### 2. 智能回答生成器

#### 2.1 回答生成流程
```python
class MemoryBasedAnswerGenerator:
    def generate_answer(self, question: dict, agent: Agent, 
                       memories: List[Concept]) -> str:
        """基於記憶生成回答"""
        
    def craft_narrative_response(self, memories: List[Concept], 
                               question_type: str) -> str:
        """構建敘事性回答"""
        
    def ensure_consistency(self, answer: str, agent: Agent) -> str:
        """確保回答一致性"""
```

#### 2.2 回答品質控制
- **長度控制**: 根據問題類型控制回答長度
- **內容審核**: 確保回答內容符合角色設定
- **語法檢查**: 確保回答語法正確自然

### 3. 增強的AI填寫器

#### 3.1 新的AIFiller架構
```python
class EnhancedAIResidentSurveyFiller(AIResidentSurveyFiller):
    def __init__(self, survey_manager: SurveyManager):
        super().__init__(survey_manager)
        self.memory_retriever = MemoryRetriever()
        self.answer_generator = MemoryBasedAnswerGenerator()
        
    def _generate_memory_based_answer(self, question: dict, 
                                    agent: Agent) -> str:
        """基於記憶生成答案"""
```

#### 3.2 記憶管理增強
- **記憶更新**: 問卷填寫過程也會產生新記憶
- **經驗累積**: 多次問卷形成問卷回答經驗
- **學習機制**: 從回答中學習改進策略

## 🎨 UI/UX 設計改進

### 1. 問卷管理介面

#### 1.1 記憶驅動的問卷設計
- **記憶標籤**: 為問題添加記憶相關標籤
- **智能建議**: 系統建議最適合的問題類型
- **預覽模式**: 預覽AI可能的回答風格

#### 1.2 結果分析儀表板
- **記憶影響分析**: 顯示哪些記憶最常影響回答
- **個性化趨勢**: 分析每個居民的回答模式
- **一致性報告**: 檢查回答的一致性水平

### 2. 互動體驗優化

#### 2.1 即時反饋系統
- **填寫進度**: 實時顯示AI填寫進度
- **記憶檢索狀態**: 顯示正在檢索的記憶類型
- **生成過程**: 透明展示回答生成過程

#### 2.2 可定制化選項
- **記憶範圍**: 可設定檢索記憶的時間範圍
- **詳細程度**: 可調整回答的詳細程度
- **風格偏好**: 可選擇回答風格傾向

## 📊 成功指標 (KPIs)

### 1. 技術指標
- **記憶檢索準確率**: >85%
- **回答生成時間**: <5秒
- **系統可用性**: >99%
- **記憶相關性分數**: >0.7

### 2. 品質指標
- **回答自然度評分**: >4.0/5.0
- **一致性檢查通過率**: >90%
- **個性化程度**: 每個居民回答差異度 >70%
- **用戶滿意度**: >4.2/5.0

### 3. 功能指標
- **記憶覆蓋率**: >80%的問題能找到相關記憶
- **回答多樣性**: 避免模板化回答 >85%
- **錯誤率**: <5%的邏輯錯誤或矛盾

## 🚀 實施計劃

### Phase 1: 記憶整合 (Week 1-2)
- [ ] 分析現有記憶系統結構
- [ ] 設計記憶檢索接口
- [ ] 實現基礎記憶查詢功能
- [ ] 建立記憶相關性評分算法

### Phase 2: 回答生成 (Week 3-4)
- [ ] 設計回答生成模板
- [ ] 實現個性化語言風格
- [ ] 建立一致性檢查機制
- [ ] 優化回答品質控制

### Phase 3: 系統整合 (Week 5-6)
- [ ] 整合記憶系統與問卷系統
- [ ] 實現增強的AI填寫器
- [ ] 建立回答記錄系統
- [ ] 完成端到端測試

### Phase 4: UI優化 (Week 7-8)
- [ ] 設計記憶可視化界面
- [ ] 實現即時反饋系統
- [ ] 優化用戶交互體驗
- [ ] 完成多語言支援

### Phase 5: 測試優化 (Week 9-10)
- [ ] 進行全面系統測試
- [ ] 收集用戶反饋
- [ ] 性能優化調整
- [ ] 文檔完善和交付

## 📝 風險與應對

### 1. 技術風險
- **記憶檢索性能**: 大量記憶可能影響檢索速度
  - **應對**: 實現記憶索引和快取機制
- **一致性保證**: 確保多次回答的一致性
  - **應對**: 建立回答記錄和一致性檢查機制

### 2. 品質風險
- **回答自然度**: AI回答可能仍顯生硬
  - **應對**: 多樣化回答模板和後處理優化
- **記憶相關性**: 檢索到的記憶可能不夠相關
  - **應對**: 持續優化檢索算法和相關性評分

### 3. 用戶體驗風險
- **回答時間過長**: 記憶檢索可能耗時較長
  - **應對**: 異步處理和進度提示
- **界面複雜度**: 新功能可能增加界面複雜度
  - **應對**: 漸進式功能展示和用戶引導

## 🔧 開發資源需求

### 1. 人力需求
- **後端開發**: 2人週 (記憶系統整合)
- **前端開發**: 1.5人週 (UI優化)
- **測試**: 1人週 (功能測試)
- **文檔**: 0.5人週 (技術文檔)

### 2. 技術資源
- **現有框架**: llama-index, chromadb, Flask
- **新增依賴**: 可能需要額外的NLP處理庫
- **硬體需求**: 無額外硬體需求

### 3. 時間規劃
- **總時程**: 10週
- **里程碑檢查**: 每2週一次
- **發布時間**: 第10週末

---

**文件版本**: v1.0  
**創建日期**: 2025-10-02  
**負責人**: Claude Code Assistant  
**審核狀態**: 待審核  