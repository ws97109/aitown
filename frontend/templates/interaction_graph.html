<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>Reverie - è§’è‰²äº’å‹•é—œä¿‚è¦–è¦ºåŒ–</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/css/bootstrap-theme.min.css">
  <style>
    .node text {
      pointer-events: none;
      font-family: sans-serif;
    }
    
    .node circle {
      stroke-width: 1.5px;
    }
    
    .link {
      stroke: #999;
      stroke-opacity: 0.6;
    }

    .chart-container {
      border: 1px solid #ddd;
      overflow: hidden;
      cursor: grab;
    }

    .chart-container:active {
      cursor: grabbing;
    }

    .controls {
      margin-top: 10px;
    }

    .btn-group {
      margin-right: 10px;
    }

    .stats-info {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 5px;
      margin: 10px 0;
    }

    .persona-info {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 10px;
      margin: 10px 0;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    .persona-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }

    .persona-card {
      background: white;
      border-radius: 10px;
      padding: 15px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 3px solid transparent;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .persona-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
    }

    .persona-card.active {
      border-color: #667eea;
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
    }

    .persona-avatar {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      margin: 0 auto 10px;
      object-fit: cover;
      border: 3px solid #eee;
    }

    .persona-name {
      font-weight: bold;
      color: #333;
      margin: 0;
    }

    .detail-section {
      background: white;
      border-radius: 10px;
      padding: 20px;
      margin: 20px 0;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .section-title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 15px;
      color: #333;
      border-bottom: 2px solid #667eea;
      padding-bottom: 8px;
    }

    .bar-chart {
      margin: 20px 0;
    }

    .bar-item {
      display: flex;
      align-items: center;
      margin: 10px 0;
      padding: 8px;
      background: #f8f9fa;
      border-radius: 5px;
      transition: background-color 0.3s ease;
    }

    .bar-item:hover {
      background: #e9ecef;
    }

    .bar-label {
      min-width: 120px;
      font-weight: 500;
      color: #333;
    }

    .bar-visual {
      flex-grow: 1;
      height: 20px;
      background: #e9ecef;
      border-radius: 10px;
      margin: 0 10px;
      position: relative;
      overflow: hidden;
    }

    .bar-fill {
      height: 100%;
      border-radius: 10px;
      transition: width 0.8s ease;
    }

    .bar-fill.interaction {
      background: linear-gradient(90deg, #667eea, #764ba2);
    }

    .bar-fill.location {
      background: linear-gradient(90deg, #f093fb, #f5576c);
    }

    .bar-fill.object {
      background: linear-gradient(90deg, #4ecdc4, #44a08d);
    }

    .bar-value {
      min-width: 40px;
      text-align: right;
      font-weight: bold;
      color: #667eea;
    }

    .info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin: 15px 0;
    }

    .info-item {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      border-left: 4px solid #667eea;
    }

    .info-label {
      font-weight: bold;
      color: #667eea;
      margin-bottom: 5px;
    }

    .info-value {
      color: #333;
      line-height: 1.4;
    }

    .empty-state {
      text-align: center;
      padding: 40px;
      color: #666;
      font-style: italic;
    }
  </style>
</head>

<body class="top-navigation" style="background-color: white">
  <div class="container-fluid">
    <div class="row">
      <div class="col-md-12">
        <a href="/" class="btn btn-primary">è¿”å›ä¸»é </a>
        <h2 class="text-center">è§’è‰²äº’å‹•é—œä¿‚è¦–è¦ºåŒ–</h2>
        
        <!-- çµ±è¨ˆä¿¡æ¯ -->
        <div class="stats-info">
          <div class="row">
            <div class="col-md-3">
              <strong>ç¸½è§’è‰²æ•¸ï¼š</strong><span id="total-personas">0</span>
            </div>
            <div class="col-md-3">
              <strong>äº’å‹•å°æ•¸ï¼š</strong><span id="total-interactions">0</span>
            </div>
            <div class="col-md-3">
              <strong>ç¸½äº’å‹•æ¬¡æ•¸ï¼š</strong><span id="total-interaction-count">0</span>
            </div>
            <div class="col-md-3">
              <strong>ç¸½å°è©±å­—æ•¸ï¼š</strong><span id="total-chat-length">0</span>
            </div>
          </div>
        </div>
        
        <!-- é ç±¤å°èˆª -->
        <ul class="nav nav-tabs" role="tablist">
          <li role="presentation" class="active">
            <a href="#force-directed" aria-controls="force-directed" role="tab" data-toggle="tab">äº’å‹•æ¬¡æ•¸åŠ›å°å‘åœ–</a>
          </li>
          <li role="presentation">
            <a href="#chat-matrix" aria-controls="chat-matrix" role="tab" data-toggle="tab">å°è©±é•·åº¦çŸ©é™£åœ–</a>
          </li>
          <li role="presentation">
            <a href="#persona-details" aria-controls="persona-details" role="tab" data-toggle="tab">è§’è‰²è©³ç´°è³‡æ–™</a>
          </li>
        </ul>
        
        <!-- é ç±¤å…§å®¹ -->
        <div class="tab-content">
          <!-- äº’å‹•æ¬¡æ•¸åŠ›å°å‘åœ– -->
          <div role="tabpanel" class="tab-pane active" id="force-directed">
            <div class="chart-container" style="width: 100%; height: 600px;"></div>
            <div class="controls">
              <div class="btn-group" role="group">
                <button id="zoom-in" class="btn btn-sm btn-default">æ”¾å¤§ (+)</button>
                <button id="zoom-out" class="btn btn-sm btn-default">ç¸®å° (-)</button>
                <button id="reset-zoom" class="btn btn-sm btn-default">é‡ç½®è¦–åœ–</button>
              </div>
              <div class="btn-group" role="group">
                <button id="center-graph" class="btn btn-sm btn-default">å±…ä¸­é¡¯ç¤º</button>
                <button id="fit-to-screen" class="btn btn-sm btn-default">é©åˆç•«é¢</button>
              </div>
              <span style="margin-left: 20px; font-size: 12px; color: #666;">
                æç¤º: å¯ä»¥æ‹–æ›³ç•«å¸ƒç§»å‹•è¦–åœ–ï¼Œæ»¾è¼ªç¸®æ”¾ï¼Œæ‹–æ›³ç¯€é»èª¿æ•´ä½ç½®
              </span>
            </div>
          </div>
          
          <!-- å°è©±é•·åº¦çŸ©é™£åœ– -->
          <div role="tabpanel" class="tab-pane" id="chat-matrix">
            <div class="chart-container" style="width: 100%; height: 600px;"></div>
            <div id="debug-info" style="margin-top: 10px; font-family: monospace; font-size: 12px;"></div>
          </div>

          <!-- è§’è‰²è©³ç´°è³‡æ–™ -->
          <div role="tabpanel" class="tab-pane" id="persona-details">
            <div class="persona-info">
              <h3 style="margin: 0 0 15px 0; text-align: center;">ğŸ­ é¸æ“‡è§’è‰²æŸ¥çœ‹è©³ç´°è³‡æ–™</h3>
              <p style="text-align: center; margin: 0; opacity: 0.9;">é»æ“Šä¸‹æ–¹è§’è‰²é ­åƒæŸ¥çœ‹å…¶åŸºæœ¬è³‡æ–™ã€ç¤¾äº¤é—œä¿‚å’Œæ´»å‹•çµ±è¨ˆ</p>
            </div>

            <!-- è§’è‰²é¸æ“‡ç¶²æ ¼ -->
            <div class="persona-grid" id="persona-grid">
              <!-- å°‡ç”±JavaScriptå‹•æ…‹ç”Ÿæˆ -->
            </div>

            <!-- è§’è‰²è©³ç´°ä¿¡æ¯é¡¯ç¤ºå€åŸŸ -->
            <div id="persona-detail-content" style="display: none;">
              <!-- åŸºæœ¬è³‡æ–™ -->
              <div class="detail-section">
                <div class="section-title">ğŸ‘¤ åŸºæœ¬è³‡æ–™</div>
                <div class="info-grid" id="basic-info">
                  <!-- å°‡ç”±JavaScriptå‹•æ…‹ç”Ÿæˆ -->
                </div>
              </div>

              <!-- ç¤¾äº¤é—œä¿‚åœ–è¡¨ -->
              <div class="detail-section">
                <div class="section-title">ğŸ’¬ ç¤¾äº¤é—œä¿‚çµ±è¨ˆ</div>
                <div class="bar-chart" id="interaction-chart">
                  <!-- å°‡ç”±JavaScriptå‹•æ…‹ç”Ÿæˆ -->
                </div>
              </div>

              <!-- æ´»å‹•åœ°å€çµ±è¨ˆ -->
              <div class="detail-section">
                <div class="section-title">ğŸ  æ´»å‹•åœ°å€çµ±è¨ˆ</div>
                <div class="bar-chart" id="location-chart">
                  <!-- å°‡ç”±JavaScriptå‹•æ…‹ç”Ÿæˆ -->
                </div>
              </div>

              <!-- ç‰©å“äº’å‹•çµ±è¨ˆ -->
              <div class="detail-section">
                <div class="section-title">ğŸ”§ ç‰©å“äº’å‹•çµ±è¨ˆ</div>
                <div class="bar-chart" id="object-chart">
                  <!-- å°‡ç”±JavaScriptå‹•æ…‹ç”Ÿæˆ -->
                </div>
              </div>
            </div>

            <!-- ç©ºç‹€æ…‹ -->
            <div id="empty-state" class="empty-state">
              <h4>è«‹é¸æ“‡ä¸€å€‹è§’è‰²</h4>
              <p>é»æ“Šä¸Šæ–¹çš„è§’è‰²é ­åƒä¾†æŸ¥çœ‹è©³ç´°è³‡æ–™</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-latest.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/js/bootstrap.min.js"></script>
  <script src="https://d3js.org/d3.v6.min.js"></script>
  
  <script>
    // å¾å¾Œç«¯ç²å–æ•¸æ“š
    const interactionData = JSON.parse('{{ interaction_data | safe }}');
    const chatLengthData = JSON.parse('{{ chat_length_data | safe }}');
    const allInteractionData = JSON.parse('{{ all_interaction_data | safe }}');
    const personaNames = {{ persona_names | tojson }};
    
    console.log('Interaction Data:', interactionData);
    console.log('Chat Length Data:', chatLengthData);
    console.log('All Interaction Data:', allInteractionData);
    console.log('Persona Names:', personaNames);

    // å…¨å±€è®Šæ•¸
    let forceDirectedSvg = null;
    let forceDirectedG = null;
    let zoom = null;
    let simulation = null;
    let currentSelectedPersona = null;

    // è§’è‰²åŸºæœ¬è³‡æ–™
    const personaProfiles = allInteractionData.persona_profiles || {};

    // ç•¶é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–åœ–è¡¨
    document.addEventListener('DOMContentLoaded', function() {
      // æ›´æ–°çµ±è¨ˆä¿¡æ¯
      updateStatistics();
      
      // åˆå§‹åŒ–è§’è‰²é¸æ“‡ç¶²æ ¼
      initializePersonaGrid();
      
      // åˆå§‹åŒ–äº’å‹•æ¬¡æ•¸åŠ›å°å‘åœ–
      createForceDirectedGraph(interactionData, "#force-directed .chart-container");
      
      // é ç±¤åˆ‡æ›æ™‚é‡æ–°èª¿æ•´åœ–è¡¨å¤§å°
      $('a[data-toggle="tab"]').on('shown.bs.tab', function(e) {
        const target = $(e.target).attr("href");
        if (target === '#chat-matrix') {
          createChatLengthMatrix(chatLengthData, "#chat-matrix .chart-container", personaNames);
        }
        window.dispatchEvent(new Event('resize'));
      });
      
      // ç¶å®šæ§åˆ¶æŒ‰éˆ•äº‹ä»¶
      bindControlEvents();
    });

    function updateStatistics() {
      const totalPersonas = personaNames.length;
      const totalInteractions = interactionData.links.length;
      const totalInteractionCount = interactionData.links.reduce((sum, link) => sum + link.value, 0);
      const totalChatLength = chatLengthData.links.reduce((sum, link) => sum + link.length, 0);
      
      document.getElementById('total-personas').textContent = totalPersonas;
      document.getElementById('total-interactions').textContent = totalInteractions;
      document.getElementById('total-interaction-count').textContent = totalInteractionCount;
      document.getElementById('total-chat-length').textContent = totalChatLength;
    }

    // åˆå§‹åŒ–è§’è‰²é¸æ“‡ç¶²æ ¼
    function initializePersonaGrid() {
      const gridContainer = document.getElementById('persona-grid');
      gridContainer.innerHTML = '';

      personaNames.forEach(personaName => {
        const card = document.createElement('div');
        card.className = 'persona-card';
        card.dataset.persona = personaName;
        
        card.innerHTML = `
          <img src="/static/assets/village/agents/${personaName}/portrait.png" 
               alt="${personaName}" 
               class="persona-avatar"
               onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMzAiIGN5PSIzMCIgcj0iMzAiIGZpbGw9IiM2NjdlZWEiLz4KPGV4dCB4PSIzMCIgeT0iMzUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IndoaXRlIiBmb250LXNpemU9IjE0Ij7jgJo8L3RleHQ+Cjwvc3ZnPgo='">
          <p class="persona-name">${personaName}</p>
        `;

        card.addEventListener('click', () => selectPersona(personaName));
        gridContainer.appendChild(card);
      });
    }

    // é¸æ“‡è§’è‰²
    function selectPersona(personaName) {
      // æ›´æ–°é¸ä¸­ç‹€æ…‹
      document.querySelectorAll('.persona-card').forEach(card => {
        card.classList.remove('active');
      });
      document.querySelector(`[data-persona="${personaName}"]`).classList.add('active');

      currentSelectedPersona = personaName;
      
      // é¡¯ç¤ºè§’è‰²è©³ç´°ä¿¡æ¯
      showPersonaDetails(personaName);
      
      // éš±è—ç©ºç‹€æ…‹ï¼Œé¡¯ç¤ºè©³ç´°å…§å®¹
      document.getElementById('empty-state').style.display = 'none';
      document.getElementById('persona-detail-content').style.display = 'block';
    }

    // é¡¯ç¤ºè§’è‰²è©³ç´°ä¿¡æ¯
    function showPersonaDetails(personaName) {
      // æ›´æ–°åŸºæœ¬è³‡æ–™
      updateBasicInfo(personaName);
      
      // æ›´æ–°ç¤¾äº¤é—œä¿‚åœ–è¡¨
      updateInteractionChart(personaName);
      
      // æ›´æ–°æ´»å‹•åœ°å€çµ±è¨ˆ
      updateLocationChart(personaName);
      
      // æ›´æ–°ç‰©å“äº’å‹•çµ±è¨ˆ
      updateObjectChart(personaName);
    }

    // æ›´æ–°åŸºæœ¬è³‡æ–™
    function updateBasicInfo(personaName) {
      const profile = personaProfiles[personaName] || {
        age: "æœªçŸ¥",
        innate: "å¾…æ¢ç´¢",
        learned: "å­¸ç¿’ä¸­",
        lifestyle: "ç”Ÿæ´»ä¸­",
        currently: "æ´»å‹•ä¸­"
      };

      const basicInfoContainer = document.getElementById('basic-info');
      basicInfoContainer.innerHTML = `
        <div class="info-item">
          <div class="info-label">å§“å</div>
          <div class="info-value">${personaName}</div>
        </div>
        <div class="info-item">
          <div class="info-label">å¹´é½¡</div>
          <div class="info-value">${profile.age}æ­²</div>
        </div>
        <div class="info-item">
          <div class="info-label">å…ˆå¤©ç‰¹è³ª</div>
          <div class="info-value">${profile.innate}</div>
        </div>
        <div class="info-item">
          <div class="info-label">å¾Œå¤©ç‰¹è³ª</div>
          <div class="info-value">${profile.learned}</div>
        </div>
        <div class="info-item">
          <div class="info-label">ç”Ÿæ´»ç¿’æ…£</div>
          <div class="info-value">${profile.lifestyle}</div>
        </div>
        <div class="info-item">
          <div class="info-label">ç•¶å‰ç‹€æ…‹</div>
          <div class="info-value">${profile.currently}</div>
        </div>
      `;
    }

    // æ›´æ–°ç¤¾äº¤é—œä¿‚åœ–è¡¨
    function updateInteractionChart(personaName) {
      const interactions = {};
      
      // å¾çœŸå¯¦çš„å°è©±äº¤äº’æ•¸æ“šä¸­çµ±è¨ˆèˆ‡å…¶ä»–è§’è‰²çš„äº’å‹•æ¬¡æ•¸
      if (allInteractionData.chat_interactions && allInteractionData.chat_interactions.links) {
        allInteractionData.chat_interactions.links.forEach(link => {
          if (link.source === personaName) {
            interactions[link.target] = (interactions[link.target] || 0) + link.value;
          } else if (link.target === personaName) {
            interactions[link.source] = (interactions[link.source] || 0) + link.value;
          }
        });
      }

      // å¦‚æœæ²’æœ‰çœŸå¯¦æ•¸æ“šï¼Œå¾åŸå§‹çš„interactionDataä¸­ç²å–
      if (Object.keys(interactions).length === 0) {
        interactionData.links.forEach(link => {
          if (link.source === personaName) {
            interactions[link.target] = (interactions[link.target] || 0) + link.value;
          } else if (link.target === personaName) {
            interactions[link.source] = (interactions[link.source] || 0) + link.value;
          }
        });
      }

      const chartContainer = document.getElementById('interaction-chart');
      
      if (Object.keys(interactions).length === 0) {
        chartContainer.innerHTML = '<div class="empty-state">æš«ç„¡ç¤¾äº¤äº’å‹•æ•¸æ“š</div>';
        return;
      }

      // ç²å–æœ€å¤§å€¼ç”¨æ–¼è¨ˆç®—æ¯”ä¾‹
      const maxValue = Math.max(...Object.values(interactions), 1);
      
      // æŒ‰äº’å‹•æ¬¡æ•¸æ’åºï¼Œé¡¯ç¤ºå‰8å€‹
      const sortedInteractions = Object.entries(interactions)
        .sort(([,a], [,b]) => b - a)
        .slice(0, 8);

      chartContainer.innerHTML = sortedInteractions.map(([partner, count]) => `
        <div class="bar-item">
          <div class="bar-label">${partner}</div>
          <div class="bar-visual">
            <div class="bar-fill interaction" style="width: ${(count / maxValue * 100)}%"></div>
          </div>
          <div class="bar-value">${count}æ¬¡</div>
        </div>
      `).join('');

      // æ·»åŠ ç¸½äº’å‹•çµ±è¨ˆä¿¡æ¯
      const totalInteractions = Object.values(interactions).reduce((sum, count) => sum + count, 0);
      const totalPartners = Object.keys(interactions).length;
      
      if (sortedInteractions.length > 0) {
        const summaryHtml = `
          <div style="margin-top: 15px; padding: 10px; background: #f0f8ff; border-radius: 5px; font-size: 12px; color: #666;">
            ğŸ“Š ç¸½è¨ˆï¼šèˆ‡ ${totalPartners} ä½è§’è‰²é€²è¡Œäº† ${totalInteractions} æ¬¡äº’å‹•
          </div>
        `;
        chartContainer.innerHTML += summaryHtml;
      }
    }

    // æ›´æ–°æ´»å‹•åœ°å€çµ±è¨ˆ
    function updateLocationChart(personaName) {
      const locations = {};
      
      // å¾çœŸå¯¦æ•¸æ“šä¸­ç²å–è©²è§’è‰²çš„åœ°å€äº¤äº’æ•¸æ“š
      if (allInteractionData.location_interactions) {
        allInteractionData.location_interactions.forEach(interaction => {
          if (interaction.agent === personaName) {
            locations[interaction.location] = interaction.count;
          }
        });
      }

      // å¦‚æœæ²’æœ‰çœŸå¯¦æ•¸æ“šï¼Œä½¿ç”¨æ¨¡æ“¬æ•¸æ“š
      if (Object.keys(locations).length === 0) {
        const sampleLocations = {
          "å’–å•¡å»³": Math.floor(Math.random() * 50) + 10,
          "åœ–æ›¸é¤¨": Math.floor(Math.random() * 40) + 5,
          "è¾¦å…¬å®¤": Math.floor(Math.random() * 60) + 15,
          "å®¶": Math.floor(Math.random() * 80) + 20,
          "æ•™å®¤": Math.floor(Math.random() * 45) + 8,
          "å…¬åœ’": Math.floor(Math.random() * 25) + 3
        };
        Object.assign(locations, sampleLocations);
      }

      const maxValue = Math.max(...Object.values(locations), 1);
      const chartContainer = document.getElementById('location-chart');

      const sortedLocations = Object.entries(locations)
        .sort(([,a], [,b]) => b - a)
        .slice(0, 8); // é¡¯ç¤ºå‰8å€‹

      if (sortedLocations.length === 0) {
        chartContainer.innerHTML = '<div class="empty-state">æš«ç„¡æ´»å‹•åœ°å€æ•¸æ“š</div>';
        return;
      }

      chartContainer.innerHTML = sortedLocations.map(([location, count]) => `
        <div class="bar-item">
          <div class="bar-label">${location}</div>
          <div class="bar-visual">
            <div class="bar-fill location" style="width: ${(count / maxValue * 100)}%"></div>
          </div>
          <div class="bar-value">${count}</div>
        </div>
      `).join('');
    }

    // æ›´æ–°ç‰©å“äº’å‹•çµ±è¨ˆ
    function updateObjectChart(personaName) {
      const objects = {};
      
      // å¾çœŸå¯¦æ•¸æ“šä¸­ç²å–è©²è§’è‰²çš„ç‰©å“äº¤äº’æ•¸æ“š
      if (allInteractionData.object_interactions) {
        allInteractionData.object_interactions.forEach(interaction => {
          if (interaction.agent === personaName) {
            objects[interaction.object] = interaction.count;
          }
        });
      }

      // å¦‚æœæ²’æœ‰çœŸå¯¦æ•¸æ“šï¼Œä½¿ç”¨æ¨¡æ“¬æ•¸æ“š
      if (Object.keys(objects).length === 0) {
        const sampleObjects = {
          "é›»è…¦": Math.floor(Math.random() * 100) + 20,
          "æ›¸ç±": Math.floor(Math.random() * 60) + 10,
          "å’–å•¡æ©Ÿ": Math.floor(Math.random() * 40) + 5,
          "æ‰‹æ©Ÿ": Math.floor(Math.random() * 120) + 30,
          "ç™½æ¿": Math.floor(Math.random() * 35) + 8,
          "æ¡Œæ¤…": Math.floor(Math.random() * 80) + 15
        };
        Object.assign(objects, sampleObjects);
      }

      const maxValue = Math.max(...Object.values(objects), 1);
      const chartContainer = document.getElementById('object-chart');

      const sortedObjects = Object.entries(objects)
        .sort(([,a], [,b]) => b - a)
        .slice(0, 8); // é¡¯ç¤ºå‰8å€‹

      if (sortedObjects.length === 0) {
        chartContainer.innerHTML = '<div class="empty-state">æš«ç„¡ç‰©å“äº’å‹•æ•¸æ“š</div>';
        return;
      }

      chartContainer.innerHTML = sortedObjects.map(([object, count]) => `
        <div class="bar-item">
          <div class="bar-label">${object}</div>
          <div class="bar-visual">
            <div class="bar-fill object" style="width: ${(count / maxValue * 100)}%"></div>
          </div>
          <div class="bar-value">${count}</div>
        </div>
      `).join('');
    }

    // å‰µå»ºåŠ›å°å‘åœ–
    function createForceDirectedGraph(data, containerSelector) {
      // æ¸…ç©ºå®¹å™¨
      d3.select(containerSelector).html("");
      
      // è¨­ç½®ç•«å¸ƒå¤§å°
      const container = document.querySelector(containerSelector);
      const width = container.clientWidth;
      const height = 600;

      // å®šç¾©é¡è‰²æ¯”ä¾‹å°º
      const color = d3.scaleOrdinal(d3.schemeCategory10);

      // å‰µå»ºSVGå…ƒç´ 
      const svg = d3.select(containerSelector)
        .append("svg")
        .attr("width", width)
        .attr("height", height);
      
      // ä¿å­˜å…¨å±€å¼•ç”¨
      forceDirectedSvg = svg;
      
      // æ·»åŠ ç¸®æ”¾å’Œå¹³ç§»åŠŸèƒ½
      zoom = d3.zoom()
        .scaleExtent([0.1, 10])
        .on("zoom", function(event) {
          g.attr("transform", event.transform);
        });
      
      svg.call(zoom);
      
      // ä¸»åœ–å±¤
      const g = svg.append("g");
      forceDirectedG = g;

      // æª¢æŸ¥æ•¸æ“š
      if (!data.links || data.links.length === 0) {
        g.append("text")
          .attr("x", width / 2)
          .attr("y", height / 2)
          .attr("text-anchor", "middle")
          .attr("font-size", "18px")
          .attr("fill", "#666")
          .text("æš«ç„¡äº’å‹•æ•¸æ“š");
        return;
      }

      // å‰µå»ºåŠ›å°å‘åœ–æ¨¡æ“¬
      simulation = d3.forceSimulation(data.nodes)
        .force("link", d3.forceLink(data.links).id(d => d.id).distance(d => Math.max(50, 200 - d.value * 5)))
        .force("charge", d3.forceManyBody().strength(-800))
        .force("center", d3.forceCenter(width / 2, height / 2))
        .force("collision", d3.forceCollide().radius(50));

      // ç¹ªè£½é€£ç·š
      const link = g.append("g")
        .selectAll("line")
        .data(data.links)
        .enter()
        .append("line")
        .attr("stroke-width", d => Math.min(Math.sqrt(d.value) * 3, 10))
        .attr("stroke", "#999")
        .attr("stroke-opacity", 0.6);

      // å‰µå»ºç¯€é»çµ„
      const node = g.append("g")
        .selectAll(".node")
        .data(data.nodes)
        .enter()
        .append("g")
        .attr("class", "node")
        .style("cursor", "pointer")
        .call(d3.drag()
          .on("start", dragstarted)
          .on("drag", dragged)
          .on("end", dragended));

      // æ·»åŠ é ­åƒåœ–ç‰‡ (èƒŒæ™¯åœ“å½¢)
      node.append("circle")
        .attr("r", 30)
        .attr("fill", "#fff")
        .attr("stroke", d => color(d.group))
        .attr("stroke-width", 3);

      // æ·»åŠ é ­åƒåœ–ç‰‡
      node.append("image")
        .attr("xlink:href", d => "/static/assets/village/agents/" + d.id + "/portrait.png")
        .attr("x", -25)
        .attr("y", -25)
        .attr("width", 50)
        .attr("height", 50)
        .attr("clip-path", "circle(25px at 25px 25px)")
        .style("pointer-events", "none");

      // æ·»åŠ è§’è‰²åç¨±
      node.append("text")
        .attr("dy", 45)
        .attr("text-anchor", "middle")
        .text(d => d.id)
        .attr("font-family", "é»‘é«”")
        .attr("font-size", "14px")
        .attr("fill", "#333")
        .attr("font-weight", "bold")
        .attr("pointer-events", "none");

      // æ·»åŠ äº’å‹•æ¬¡æ•¸æ–‡æœ¬åˆ°é€£ç·šä¸Š
      const linkText = g.append("g")
        .selectAll(".link-text")
        .data(data.links)
        .enter()
        .append("text")
        .attr("class", "link-text")
        .text(d => d.value)
        .attr("font-family", "é»‘é«”")
        .attr("font-size", "12px")
        .attr("fill", "#333")
        .attr("text-anchor", "middle")
        .attr("dy", -5)
        .attr("pointer-events", "none")
        .attr("font-weight", "bold");

      // æ·»åŠ hoveræ•ˆæœå’Œé»æ“Šäº‹ä»¶
      node.on("mouseover", function(event, d) {
        d3.select(this).select("circle")
          .transition()
          .duration(200)
          .attr("r", 35)
          .attr("stroke-width", 5);
        
        d3.select(this).select("image")
          .transition()
          .duration(200)
          .attr("x", -30)
          .attr("y", -30)
          .attr("width", 60)
          .attr("height", 60);
        
        // é«˜äº®ç›¸é—œé€£ç·š
        link.style("stroke-opacity", l => 
          l.source.id === d.id || l.target.id === d.id ? 1 : 0.1
        );
        linkText.style("opacity", l => 
          l.source.id === d.id || l.target.id === d.id ? 1 : 0.1
        );

        // é¡¯ç¤ºè©³ç´°ä¿¡æ¯
        showNodeInfo(d, data.links);
      })
      .on("mouseout", function(event, d) {
        d3.select(this).select("circle")
          .transition()
          .duration(200)
          .attr("r", 30)
          .attr("stroke-width", 3);
        
        d3.select(this).select("image")
          .transition()
          .duration(200)
          .attr("x", -25)
          .attr("y", -25)
          .attr("height", 50);
        
        // æ¢å¾©æ‰€æœ‰é€£ç·š
        link.style("stroke-opacity", 0.6);
        linkText.style("opacity", 1);
      })
      .on("click", function(event, d) {
        // é»æ“Šç¯€é»æ™‚åˆ‡æ›åˆ°è§’è‰²è©³ç´°è³‡æ–™é ç±¤ä¸¦é¸ä¸­è©²è§’è‰²
        $('a[href="#persona-details"]').tab('show');
        setTimeout(() => {
          selectPersona(d.id);
        }, 100);
      });

      // æ¨¡æ“¬å‹•ç•«
      simulation.on("tick", () => {
        link
          .attr("x1", d => d.source.x)
          .attr("y1", d => d.source.y)
          .attr("x2", d => d.target.x)
          .attr("y2", d => d.target.y);

        node
          .attr("transform", d => `translate(${d.x}, ${d.y})`);

        linkText
          .attr("x", d => (d.source.x + d.target.x) / 2)
          .attr("y", d => (d.source.y + d.target.y) / 2);
      });

      // æ‹–æ›³åŠŸèƒ½
      function dragstarted(event, d) {
        if (!event.active) simulation.alphaTarget(0.3).restart();
        d.fx = d.x;
        d.fy = d.y;
      }

      function dragged(event, d) {
        d.fx = event.x;
        d.fy = event.y;
      }

      function dragended(event, d) {
        if (!event.active) simulation.alphaTarget(0);
        // ä¿æŒå›ºå®šä½ç½®ï¼Œä¾¿æ–¼è§€å¯Ÿ
        // d.fx = null;
        // d.fy = null;
      }

      // åˆå§‹åŒ–è¦–åœ–
      setTimeout(() => {
        fitToScreen();
      }, 1000);
    }

    function showNodeInfo(node, links) {
      const connections = links.filter(link => 
        link.source.id === node.id || link.target.id === node.id
      );
      
      const totalInteractions = connections.reduce((sum, link) => sum + link.value, 0);
      
      console.log(`${node.id} çš„äº’å‹•è©³æƒ…:`);
      console.log(`- ç¸½äº’å‹•æ¬¡æ•¸: ${totalInteractions}`);
      console.log(`- äº’å‹•å°è±¡: ${connections.length}`);
      connections.forEach(link => {
        const partner = link.source.id === node.id ? link.target.id : link.source.id;
        console.log(`  èˆ‡ ${partner}: ${link.value} æ¬¡`);
      });
    }

    // å‰µå»ºå°è©±é•·åº¦çŸ©é™£åœ–
    function createChatLengthMatrix(data, containerSelector, personas) {
      // æ¸…ç©ºå®¹å™¨
      d3.select(containerSelector).html("");
      
      if (!personas || personas.length === 0) {
        throw new Error("æ²’æœ‰è§’è‰²æ•¸æ“š");
      }
      
      // å‰µå»ºçŸ©é™£
      let matrix = [];
      for (let i = 0; i < personas.length; i++) {
        let row = [];
        for (let j = 0; j < personas.length; j++) {
          row.push(0);
        }
        matrix.push(row);
      }
      
      // å¡«å……çŸ©é™£æ•¸æ“š
      const linksData = data.links || [];
      
      for (let link of linksData) {
        const source = link.source;
        const target = link.target;
        const value = link.length || 0;
        
        const sourceIdx = personas.indexOf(source);
        const targetIdx = personas.indexOf(target);
        
        if (sourceIdx >= 0 && targetIdx >= 0) {
          matrix[sourceIdx][targetIdx] = value;
          matrix[targetIdx][sourceIdx] = value; // å°ç¨±çŸ©é™£
        }
      }
      
      // è¨­ç½®ç•«å¸ƒå°ºå¯¸
      const margin = { top: 100, right: 100, bottom: 20, left: 100 };
      const width = document.querySelector(containerSelector).clientWidth - margin.left - margin.right;
      const height = 600 - margin.top - margin.bottom;
      
      const cellSize = Math.min(width / personas.length, height / personas.length);
      
      // å‰µå»ºSVG
      const svg = d3.select(containerSelector)
        .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", `translate(${margin.left},${margin.top})`);
      
      // å®šç¾©é¡è‰²æ¯”ä¾‹å°º
      const maxVal = d3.max(matrix, row => d3.max(row)) || 1;
      const color = d3.scaleSequential()
        .domain([0, maxVal])
        .interpolator(d3.interpolateYlOrRd);
      
      // æ·»åŠ è¡Œæ¨™ç±¤
      svg.selectAll(".row-text")
        .data(personas)
        .enter()
        .append("text")
        .attr("class", "row-text")
        .attr("x", -10)
        .attr("y", (d, i) => i * cellSize + cellSize / 2)
        .attr("text-anchor", "end")
        .attr("alignment-baseline", "middle")
        .attr("font-family", "é»‘é«”")
        .attr("font-size", "12px")
        .text(d => d);
      
      // æ·»åŠ åˆ—æ¨™ç±¤
      svg.selectAll(".col-text")
        .data(personas)
        .enter()
        .append("text")
        .attr("class", "col-text")
        .attr("x", (d, i) => i * cellSize + cellSize / 2)
        .attr("y", -10)
        .attr("text-anchor", "middle")
        .attr("font-family", "é»‘é«”")
        .attr("font-size", "12px")
        .text(d => d);
      
      // ç¹ªè£½çŸ©é™£å–®å…ƒæ ¼
      personas.forEach((source, i) => {
        personas.forEach((target, j) => {
          if (i === j) return; // è·³éå°è§’ç·š
          
          const value = matrix[i][j];
          
          svg.append("rect")
            .attr("x", j * cellSize)
            .attr("y", i * cellSize)
            .attr("width", cellSize - 1)
            .attr("height", cellSize - 1)
            .attr("fill", value > 0 ? color(value) : "#f8f8f8")
            .attr("stroke", "#ccc")
            .attr("stroke-width", 1)
            .style("cursor", "pointer")
            .on("mouseover", function() {
              d3.select(this).attr("stroke", "#333").attr("stroke-width", 2);
            })
            .on("mouseout", function() {
              d3.select(this).attr("stroke", "#ccc").attr("stroke-width", 1);
            })
            .on("click", function() {
              // é»æ“ŠçŸ©é™£å–®å…ƒæ ¼æ™‚åˆ‡æ›åˆ°è§’è‰²è©³ç´°è³‡æ–™é ç±¤ä¸¦é¸ä¸­æºè§’è‰²
              $('a[href="#persona-details"]').tab('show');
              setTimeout(() => {
                selectPersona(source);
              }, 100);
            })
            .append("title")
            .text(`${source} â†” ${target}: ${value} å­—ç¬¦`);
          
          if (value > 0) {
            svg.append("text")
              .attr("x", j * cellSize + cellSize / 2)
              .attr("y", i * cellSize + cellSize / 2)
              .attr("text-anchor", "middle")
              .attr("alignment-baseline", "middle")
              .attr("font-family", "é»‘é«”")
              .attr("font-size", "10px")
              .attr("fill", value > maxVal/2 ? "white" : "black")
              .text(value);
          }
        });
      });
      
      // æ·»åŠ åœ–è¡¨æ¨™é¡Œ
      svg.append("text")
        .attr("x", (personas.length * cellSize) / 2)
        .attr("y", -margin.top / 2)
        .attr("text-anchor", "middle")
        .attr("font-family", "é»‘é«”")
        .attr("font-size", "16px")
        .attr("font-weight", "bold")
        .text("è§’è‰²å°è©±é•·åº¦çŸ©é™£");
    }

    // ç¶å®šæ§åˆ¶æŒ‰éˆ•äº‹ä»¶
    function bindControlEvents() {
      document.getElementById('zoom-in').addEventListener('click', function() {
        zoomIn();
      });

      document.getElementById('zoom-out').addEventListener('click', function() {
        zoomOut();
      });

      document.getElementById('reset-zoom').addEventListener('click', function() {
        resetZoom();
      });

      document.getElementById('center-graph').addEventListener('click', function() {
        centerGraph();
      });

      document.getElementById('fit-to-screen').addEventListener('click', function() {
        fitToScreen();
      });
    }

    // ç¸®æ”¾åŠŸèƒ½
    function zoomIn() {
      if (forceDirectedSvg && zoom) {
        forceDirectedSvg.transition().duration(300).call(
          zoom.scaleBy, 1.5
        );
      }
    }

    function zoomOut() {
      if (forceDirectedSvg && zoom) {
        forceDirectedSvg.transition().duration(300).call(
          zoom.scaleBy, 0.67
        );
      }
    }

    function resetZoom() {
      if (forceDirectedSvg && zoom) {
        forceDirectedSvg.transition().duration(750).call(
          zoom.transform,
          d3.zoomIdentity
        );
      }
    }

    function centerGraph() {
      if (forceDirectedSvg && zoom) {
        const width = forceDirectedSvg.node().clientWidth || 800;
        const height = forceDirectedSvg.node().clientHeight || 600;
        
        forceDirectedSvg.transition().duration(750).call(
          zoom.transform,
          d3.zoomIdentity.translate(width / 2, height / 2).scale(1)
        );
      }
    }

    function fitToScreen() {
      if (forceDirectedSvg && zoom && simulation) {
        const width = forceDirectedSvg.node().clientWidth || 800;
        const height = forceDirectedSvg.node().clientHeight || 600;
        
        // è¨ˆç®—æ‰€æœ‰ç¯€é»çš„é‚Šç•Œ
        const nodes = simulation.nodes();
        if (nodes.length === 0) return;
        
        const xExtent = d3.extent(nodes, d => d.x);
        const yExtent = d3.extent(nodes, d => d.y);
        
        const dx = xExtent[1] - xExtent[0];
        const dy = yExtent[1] - yExtent[0];
        const x = (xExtent[0] + xExtent[1]) / 2;
        const y = (yExtent[0] + yExtent[1]) / 2;
        
        const scale = Math.min(width / dx, height / dy) * 0.8;
        
        forceDirectedSvg.transition().duration(750).call(
          zoom.transform,
          d3.zoomIdentity
            .translate(width / 2, height / 2)
            .scale(scale)
            .translate(-x, -y)
        );
      }
    }
  </script>
</body>
</html>